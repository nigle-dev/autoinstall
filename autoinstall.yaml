#cloud-config
autoinstall:
  version: 1
  #refresh-installer: # start with an up-to-date installer
  #update: yes
  source:
    id: ubuntu-desktop
  channel: stable # update from the ubuntu stable branch only
  interactive-sections: # Install groups listed here will wait for user input
    - network
    - identity

  locale: en_US.UTF-8
  keyboard:
    layout: us
  timezone: Europe/Amsterdam
  ssh:
    allow-pw: true
    install-server: true
  storage:
    grub:
      update_nvram: true
      remove_duplicate_entries: true
      probe_additional_os: false
      reorder_uefi: false
    swap:
      filename: swap.img
      maxsize: 8GB
    config:
      # Disks
      - id: disk0
        type: disk
        ptable: gpt
        wipe: superblock
        grub_device: false
        match:
          ssd: yes
          size: largest
      # Partitions
      - id: bios
        type: partition
        device: disk0
        size: 1MB
        flag: bios_grub
      - id: esp
        type: partition
        device: disk0
        grub_device: true
        size: 512MB
        flag: boot
      - id: boot
        type: partition
        device: disk0
        size: 1GB
      # LVM Physical Volumes and DM-CRYPT disk encryption
      - id: pv
        type: partition
        device: disk0
        size: -1
      - id: client_encrypted
        type: dm_crypt
        preserve: false
        key: 'SECRET_KEY'
        volume: pv
      # LVM Volume Groups and Partitions
      - id: volumegroup
        name: ubuntu-volumegroup
        type: lvm_volgroup
        devices: [client_encrypted]
        preserve: false
      - id: lv_root
        name: root
        volgroup: volumegroup
        size: 100%
        type: lvm_partition
      # Filesystems
      - id: esp_filesystem
        type: format
        volume: esp
        fstype: fat32
        label: EFI
      - id: boot_filesystem
        type: format
        volume: boot
        fstype: ext4
      - id: root_filesystem
        type: format
        fstype: ext4
        volume: lv_root
      # Filesystem Mountpoints
      - id: esp_mount
        type: mount
        device: esp_filesystem
        path: /boot/efi
      - id: boot_mount
        type: mount
        device: boot_filesystem
        path: /boot
      - id: root_mount
        type: mount
        device: root_filesystem
        path: /
